<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èƒŒåŒ…å­˜æª”ç³»çµ± - è‡ªå‹•æ¸¬è©•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        .console-text { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen p-8 flex justify-center items-start">

    <div class="w-full max-w-3xl space-y-6">
        
        <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 overflow-hidden">
            <header class="bg-amber-900/80 p-6 border-b border-amber-700/50 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                        ğŸ’¾ å­˜æª”æª¢æ¸¬å™¨ (Storage Inspector)
                    </h1>
                    <p class="text-amber-200 text-sm mt-1 opacity-80">LocalStorage & JSON Parsing</p>
                </div>
                <div id="status-badge" class="px-4 py-2 rounded-lg font-bold bg-gray-700 text-gray-400 text-sm">
                    Ready
                </div>
            </header>

            <div id="test-list" class="p-6 space-y-3"></div>

            <div class="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end gap-3">
                <button onclick="localStorage.clear(); location.reload();" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded font-bold text-sm">
                    é‡ç½®ç’°å¢ƒ
                </button>
                <button onclick="runTests()" class="px-6 py-2 bg-amber-600 hover:bg-amber-500 text-white rounded shadow-lg font-bold transition-transform hover:scale-105">
                    åŸ·è¡Œæª¢æ¸¬
                </button>
            </div>
        </div>

        <div class="bg-black rounded-xl shadow-lg border border-gray-700 overflow-hidden font-mono text-xs md:text-sm h-64 flex flex-col">
            <div class="bg-gray-800 px-4 py-2 text-gray-400 border-b border-gray-700">Debug Console</div>
            <div id="console-output" class="flex-1 overflow-y-auto p-4 space-y-1 console-text text-gray-300">
                <div class="opacity-50">> System initialized. Waiting for backpack.js...</div>
            </div>
        </div>

    </div>

    <script src="backpack.js"></script>

    <script>
        const testList = document.getElementById('test-list');
        const consoleOutput = document.getElementById('console-output');
        const statusBadge = document.getElementById('status-badge');
        let hasError = false;
        
        // é¡Œç›®æŒ‡å®šçš„ Key
        const TARGET_KEY = "my_backpack";

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            div.className = type === 'error' ? "text-red-400" : type === 'success' ? "text-green-400" : "text-gray-300";
            div.innerHTML = `<span class="opacity-50">[${time}]</span> ${msg}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function addResult(title, passed, detail) {
            const div = document.createElement('div');
            div.className = `flex justify-between items-center p-3 rounded border ${passed ? "bg-green-900/20 border-green-800" : "bg-red-900/20 border-red-800"}`;
            div.innerHTML = `
                <div>
                    <span class="font-bold ${passed ? 'text-green-400' : 'text-red-400'}">${passed ? 'âœ” PASS' : 'âœ˜ FAIL'}</span>
                    <span class="text-gray-200 ml-2 font-bold">${title}</span>
                </div>
                <div class="text-xs ${passed ? 'text-amber-300' : 'text-red-300'}">${detail}</div>
            `;
            testList.appendChild(div);
            if (!passed) hasError = true;
        }

        async function runTests() {
            testList.innerHTML = '';
            hasError = false;
            statusBadge.className = "px-4 py-2 rounded-lg font-bold bg-blue-600 text-white animate-pulse";
            statusBadge.innerText = "Running...";
            
            // æ¸…ç©ºèˆŠè³‡æ–™ä»¥ç¢ºä¿æ¸¬è©¦æº–ç¢º
            localStorage.removeItem(TARGET_KEY);
            log("ç’°å¢ƒåˆå§‹åŒ–ï¼šå·²æ¸…é™¤ LocalStorageã€‚", 'info');

            try {
                // æª¢æŸ¥ 1: å‡½å¼æ˜¯å¦å­˜åœ¨
                if (typeof saveItems !== 'function' || typeof loadItems !== 'function') {
                    throw new Error("æ‰¾ä¸åˆ° saveItems æˆ– loadItems å‡½å¼");
                }
                addResult("å‡½å¼å®šç¾©", true, "å‡½å¼åç¨±æ­£ç¢º");

                // æª¢æŸ¥ 2: å„²å­˜åŠŸèƒ½ (saveItems)
                const testData = [{id: 1, name: "Potion"}, {id: 2, name: "Sword"}];
                saveItems(testData);
                
                const rawStorage = localStorage.getItem(TARGET_KEY);
                if (rawStorage) {
                    try {
                        const parsed = JSON.parse(rawStorage);
                        if (parsed.length === 2 && parsed[1].name === "Sword") {
                            addResult("å„²å­˜åŠŸèƒ½", true, "æˆåŠŸå¯«å…¥ LocalStorage ä¸”æ ¼å¼æ­£ç¢º");
                            log("å„²å­˜æ¸¬è©¦é€šé", 'success');
                        } else {
                            addResult("å„²å­˜åŠŸèƒ½", false, "å¯«å…¥çš„å…§å®¹èˆ‡é æœŸä¸ç¬¦");
                        }
                    } catch (e) {
                        addResult("å„²å­˜åŠŸèƒ½", false, "LocalStorage å…§çš„è³‡æ–™ä¸æ˜¯æœ‰æ•ˆçš„ JSON");
                        log("JSON Parse Error: " + rawStorage, 'error');
                    }
                } else {
                    addResult("å„²å­˜åŠŸèƒ½", false, `LocalStorage ä¸­æ‰¾ä¸åˆ° Key: "${TARGET_KEY}"`);
                }

                // æª¢æŸ¥ 3: è®€å–åŠŸèƒ½ (loadItems)
                // æ‰‹å‹•æ³¨å…¥è³‡æ–™
                const mockData = JSON.stringify([{id: 99, name: "Legendary Shield"}]);
                localStorage.setItem(TARGET_KEY, mockData);
                
                const loaded = loadItems();
                if (Array.isArray(loaded) && loaded.length === 1 && loaded[0].name === "Legendary Shield") {
                    addResult("è®€å–åŠŸèƒ½", true, "æˆåŠŸå¾ LocalStorage é‚„åŸé™£åˆ—");
                    log("è®€å–æ¸¬è©¦é€šé", 'success');
                } else {
                    addResult("è®€å–åŠŸèƒ½", false, "ç„¡æ³•æ­£ç¢ºè®€å–æˆ–é‚„åŸè³‡æ–™");
                    log("è®€å–çµæœ: " + JSON.stringify(loaded), 'error');
                }

                // æª¢æŸ¥ 4: ç©ºå€¼è™•ç†
                localStorage.removeItem(TARGET_KEY); // æ¸…ç©º
                const emptyLoad = loadItems();
                if (Array.isArray(emptyLoad) && emptyLoad.length === 0) {
                    addResult("ç©ºå€¼é˜²å‘†", true, "ç„¡å­˜æª”æ™‚å›å‚³ç©ºé™£åˆ— []");
                } else {
                    addResult("ç©ºå€¼é˜²å‘†", false, "ç„¡å­˜æª”æ™‚æ‡‰å›å‚³ []ï¼Œå»å›å‚³äº† " + typeof emptyLoad);
                }

                // æª¢æŸ¥ 5: æ•´åˆæ¸¬è©¦ (addItem)
                // å…ˆå­˜ä¸€å€‹
                localStorage.setItem(TARGET_KEY, JSON.stringify([{id: 1, name: "Old Item"}]));
                if (typeof addItem === 'function') {
                    addItem("New Item"); // æ‡‰è©²è¦è®Šæˆå…©å€‹
                    const finalStorage = JSON.parse(localStorage.getItem(TARGET_KEY));
                    if (finalStorage.length === 2 && finalStorage[1].name === "New Item") {
                         addResult("æ–°å¢é“å…· (æ•´åˆ)", true, "æˆåŠŸè¿½åŠ è³‡æ–™ä¸¦ä¿å­˜");
                    } else {
                         addResult("æ–°å¢é“å…· (æ•´åˆ)", false, "æ–°å¢å¾Œè³‡æ–™é•·åº¦æˆ–å…§å®¹ä¸æ­£ç¢º");
                    }
                }

            } catch (e) {
                log(`åŸ·è¡ŒéŒ¯èª¤: ${e.message}`, 'error');
                addResult("åŸ·è¡ŒéŒ¯èª¤", false, e.message);
            }

            if (!hasError) {
                statusBadge.className = "px-4 py-2 rounded-lg font-bold bg-green-500 text-white";
                statusBadge.innerText = "ğŸ‰ å®Œç¾å­˜æª”";
                log("æ¸¬è©¦çµæŸï¼šä½ çš„èƒŒåŒ…ç³»çµ±é‹ä½œæ­£å¸¸ï¼", 'success');
            } else {
                statusBadge.className = "px-4 py-2 rounded-lg font-bold bg-red-500 text-white";
                statusBadge.innerText = "âš ï¸ æ¸¬è©¦å¤±æ•—";
            }
        }
    </script>
</body>
</html>